"use client";

import { useState, useEffect } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Shield, Heart, Users, Star, Play, ArrowRight } from "lucide-react";

// Card types
type CardType = {
  id: string;
  name: string;
  damage: number;
  health: number;
  cost: number;
  rarity: "common" | "rare" | "epic" | "legendary";
  type: "troop" | "spell" | "building";
};

// Enemy types
type EnemyType = {
  id: string;
  name: string;
  health: number;
  damage: number;
  cards: CardType[];
};

// Game state
type GameState = {
  floor: number;
  playerDeck: CardType[];
  currentEnemy: EnemyType | null;
  battleLog: string[];
  gameStatus: "idle" | "battle" | "victory" | "defeat" | "boss";
  playerHealth: number;
  enemyHealth: number;
  isBossFloor: boolean;
};

// Card database
const cardDatabase: CardType[] = [
  { id: "goblin", name: "Goblin", damage: 80, health: 50, cost: 2, rarity: "common", type: "troop" },
  { id: "archer", name: "Archer", damage: 70, health: 30, cost: 3, rarity: "common", type: "troop" },
  { id: "knight", name: "Knight", damage: 60, health: 120, cost: 3, rarity: "common", type: "troop" },
  { id: "giant", name: "Giant", damage: 120, health: 300, cost: 5, rarity: "rare", type: "troop" },
  { id: "wizard", name: "Wizard", damage: 150, health: 80, cost: 5, rarity: "rare", type: "troop" },
  { id: "fireball", name: "Fireball", damage: 200, health: 0, cost: 4, rarity: "rare", type: "spell" },
  { id: "lightning", name: "Lightning", damage: 300, health: 0, cost: 6, rarity: "epic", type: "spell" },
  { id: "prince", name: "Prince", damage: 180, health: 150, cost: 5, rarity: "epic", type: "troop" },
  { id: "dragon", name: "Dragon", damage: 250, health: 200, cost: 4, rarity: "epic", type: "troop" },
  { id: "pekkah", name: "P.E.K.K.A", damage: 300, health: 400, cost: 7, rarity: "epic", type: "troop" },
  { id: "miner", name: "Miner", damage: 100, health: 120, cost: 3, rarity: "legendary", type: "troop" },
  { id: "lava_hound", name: "Lava Hound", damage: 50, health: 500, cost: 7, rarity: "legendary", type: "troop" },
];

// Enemy database
const enemyDatabase: EnemyType[] = [
  {
    id: "goblin_gang",
    name: "Goblin Gang",
    health: 300,
    damage: 50,
    cards: [
      cardDatabase[0], // Goblin
      cardDatabase[1], // Archer
    ]
  },
  {
    id: "barbarian_horde",
    name: "Barbarian Horde",
    health: 400,
    damage: 70,
    cards: [
      cardDatabase[2], // Knight
      cardDatabase[0], // Goblin
    ]
  },
  {
    id: "skeleton_army",
    name: "Skeleton Army",
    health: 350,
    damage: 60,
    cards: [
      cardDatabase[1], // Archer
      cardDatabase[2], // Knight
    ]
  },
  {
    id: "balloon_squad",
    name: "Balloon Squad",
    health: 500,
    damage: 100,
    cards: [
      cardDatabase[3], // Giant
      cardDatabase[4], // Wizard
    ]
  },
  {
    id: "royal_giant",
    name: "Royal Giant",
    health: 600,
    damage: 120,
    cards: [
      cardDatabase[3], // Giant
      cardDatabase[5], // Fireball
    ]
  },
];

// Boss database
const bossDatabase: EnemyType[] = [
  {
    id: "giant_goblin",
    name: "Giant Goblin",
    health: 1000,
    damage: 150,
    cards: [
      cardDatabase[3], // Giant
      cardDatabase[4], // Wizard
      cardDatabase[5], // Fireball
    ]
  },
  {
    id: "lava_hound_boss",
    name: "Lava Hound Boss",
    health: 1500,
    damage: 200,
    cards: [
      cardDatabase[9], // P.E.K.K.A
      cardDatabase[8], // Dragon
      cardDatabase[6], // Lightning
      cardDatabase[7], // Prince
    ]
  },
  {
    id: "royal_champion",
    name: "Royal Champion",
    health: 2000,
    damage: 250,
    cards: [
      cardDatabase[10], // Miner
      cardDatabase[11], // Lava Hound
      cardDatabase[9], // P.E.K.K.A
      cardDatabase[8], // Dragon
      cardDatabase[7], // Prince
    ]
  },
];

export default function TowerClimbGame() {
  const [gameState, setGameState] = useState<GameState>({
    floor: 1,
    playerDeck: [],
    currentEnemy: null,
    battleLog: [],
    gameStatus: "idle",
    playerHealth: 1000,
    enemyHealth: 0,
    isBossFloor: false,
  });

  // Initialize game
  useEffect(() => {
    generateRandomDeck();
  }, []);

  // Generate a random deck for the player
  const generateRandomDeck = () => {
    const deck: CardType[] = [];
    const commonCards = cardDatabase.filter(card => card.rarity === "common");
    const rareCards = cardDatabase.filter(card => card.rarity === "rare");
    const epicCards = cardDatabase.filter(card => card.rarity === "epic");
    const legendaryCards = cardDatabase.filter(card => card.rarity === "legendary");
    
    // Add 4 common cards
    for (let i = 0; i < 4; i++) {
      const randomIndex = Math.floor(Math.random() * commonCards.length);
      deck.push(commonCards[randomIndex]);
    }
    
    // Add 2 rare cards
    for (let i = 0; i < 2; i++) {
      const randomIndex = Math.floor(Math.random() * rareCards.length);
      deck.push(rareCards[randomIndex]);
    }
    
    // Add 1 epic card
    const randomEpicIndex = Math.floor(Math.random() * epicCards.length);
    deck.push(epicCards[randomEpicIndex]);
    
    // Add 1 legendary card (10% chance)
    if (Math.random() < 0.1) {
      const randomLegendaryIndex = Math.floor(Math.random() * legendaryCards.length);
      deck.push(legendaryCards[randomLegendaryIndex]);
    }
    
    setGameState(prev => ({
      ...prev,
      playerDeck: deck,
      battleLog: [`You received a new deck for floor ${prev.floor}!`]
    }));
  };

  // Start a battle with a random enemy
  const startBattle = () => {
    const isBossFloor = gameState.floor % 5 === 0;
    const enemyPool = isBossFloor ? bossDatabase : enemyDatabase;
    const randomIndex = Math.floor(Math.random() * enemyPool.length);
    const enemy = enemyPool[randomIndex];
    
    setGameState(prev => ({
      ...prev,
      currentEnemy: enemy,
      gameStatus: "battle",
      enemyHealth: enemy.health,
      isBossFloor,
      battleLog: [`Battle started against ${enemy.name}!`]
    }));
  };

  // Player uses a card in battle
  const useCard = (card: CardType) => {
    if (gameState.gameStatus !== "battle" || !gameState.currentEnemy) return;
    
    const damage = card.damage;
    const newEnemyHealth = Math.max(0, gameState.enemyHealth - damage);
    
    const logEntry = `You used ${card.name} dealing ${damage} damage!`;
    
    setGameState(prev => ({
      ...prev,
      enemyHealth: newEnemyHealth,
      battleLog: [...prev.battleLog, logEntry]
    }));
    
    // Enemy counterattack
    setTimeout(() => {
      const enemyDamage = gameState.currentEnemy!.damage;
      const newPlayerHealth = Math.max(0, prev.playerHealth - enemyDamage);
      
      setGameState(prev => {
        const newLog = [...prev.battleLog, `${prev.currentEnemy!.name} attacked for ${enemyDamage} damage!`];
        
        // Check battle outcome
        if (newEnemyHealth <= 0) {
          newLog.push(`You defeated ${prev.currentEnemy!.name}!`);
          return {
            ...prev,
            gameStatus: "victory",
            playerHealth: newPlayerHealth,
            battleLog: newLog
          };
        }
        
        if (newPlayerHealth <= 0) {
          newLog.push(`You were defeated by ${prev.currentEnemy!.name}!`);
          return {
            ...prev,
            gameStatus: "defeat",
            playerHealth: newPlayerHealth,
            battleLog: newLog
          };
        }
        
        return {
          ...prev,
          playerHealth: newPlayerHealth,
          battleLog: newLog
        };
      });
    }, 500);
  };

  // Advance to next floor
  const advanceFloor = () => {
    if (gameState.gameStatus === "defeat") return;
    
    const newFloor = gameState.floor + 1;
    const isBossFloor = newFloor % 5 === 0;
    
    setGameState(prev => ({
      ...prev,
      floor: newFloor,
      gameStatus: "idle",
      playerHealth: 1000,
      isBossFloor,
      battleLog: [`You advanced to floor ${newFloor}! ${isBossFloor ? "Boss floor!" : ""}`]
    }));
    
    generateRandomDeck();
  };

  // Collect cards after victory
  const collectCards = () => {
    if (!gameState.currentEnemy) return;
    
    const newCards = [...gameState.playerDeck];
    const cardsToCollect = [...gameState.currentEnemy.cards];
    
    // Add collected cards to player deck
    cardsToCollect.forEach(card => {
      // Only add if not already in deck (simplified)
      if (!newCards.some(c => c.id === card.id)) {
        newCards.push(card);
      }
    });
    
    setGameState(prev => ({
      ...prev,
      playerDeck: newCards,
      gameStatus: "idle",
      battleLog: [...prev.battleLog, `You collected cards from ${prev.currentEnemy!.name}!`]
    }));
  };

  // Reset game
  const resetGame = () => {
    setGameState({
      floor: 1,
      playerDeck: [],
      currentEnemy: null,
      battleLog: ["Game reset! Starting new climb..."],
      gameStatus: "idle",
      playerHealth: 1000,
      enemyHealth: 0,
      isBossFloor: false,
    });
    generateRandomDeck();
  };

  // Get card color based on rarity
  const getCardColor = (rarity: string) => {
    switch (rarity) {
      case "common": return "bg-gray-200 border-gray-300";
      case "rare": return "bg-blue-200 border-blue-300";
      case "epic": return "bg-purple-200 border-purple-300";
      case "legendary": return "bg-yellow-200 border-yellow-300";
      default: return "bg-gray-200 border-gray-300";
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-blue-900 to-purple-900 text-white p-4">
      <div className="max-w-4xl mx-auto">
        <header className="text-center py-6">
          <h1 className="text-4xl font-bold mb-2 flex items-center justify-center">
            <Shield className="mr-2" /> Clash Tower Climb
          </h1>
          <p className="text-lg text-blue-200">Climb the tower, collect cards, and defeat bosses!</p>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Player Info */}
          <Card className="bg-blue-800/50 border-blue-700">
            <CardHeader>
              <CardTitle className="flex items-center">
                <Users className="mr-2" /> Player Info
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <div>
                  <div className="flex justify-between mb-1">
                    <span>Floor</span>
                    <span className="font-bold">{gameState.floor}</span>
                  </div>
                  <div className="w-full bg-gray-700 rounded-full h-2.5">
                    <div 
                      className="bg-green-500 h-2.5 rounded-full" 
                      style={{ width: `${(gameState.floor % 5) * 20}%` }}
                    ></div>
                  </div>
                  <p className="text-sm text-gray-300 mt-1">
                    {5 - (gameState.floor % 5)} floors until next boss
                  </p>
                </div>
                
                <div>
                  <div className="flex justify-between mb-1">
                    <span>Health</span>
                    <span className="font-bold">{gameState.playerHealth}/1000</span>
                  </div>
                  <div className="w-full bg-gray-700 rounded-full h-2.5">
                    <div 
                      className="bg-red-500 h-2.5 rounded-full" 
                      style={{ width: `${(gameState.playerHealth / 1000) * 100}%` }}
                    ></div>
                  </div>
                </div>
                
                <div className="flex gap-2">
                  <Button 
                    onClick={startBattle} 
                    disabled={gameState.gameStatus !== "idle"}
                    className="flex-1"
                  >
                    <Play className="mr-2 h-4 w-4" /> Battle
                  </Button>
                  <Button 
                    onClick={resetGame}
                    variant="outline"
                    className="border-blue-500 text-blue-300 hover:bg-blue-700"
                  >
                    Reset
                  </Button>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Battle Area */}
          <Card className="bg-blue-800/50 border-blue-700 lg:col-span-2">
            <CardHeader>
              <CardTitle className="flex items-center justify-between">
                <span className="flex items-center">
                  {gameState.isBossFloor ? (
                    <>
                      <Star className="mr-2 text-yellow-400" /> Boss Battle
                    </>
                  ) : (
                    <>
                      <Shield className="mr-2" /> Battle Arena
                    </>
                  )}
                </span>
                <span className="text-lg">
                  Floor {gameState.floor}
                </span>
              </CardTitle>
            </CardHeader>
            <CardContent>
              {gameState.gameStatus === "idle" && (
                <div className="text-center py-12">
                  <div className="mb-6">
                    <div className="bg-gray-200 border-2 border-dashed rounded-xl w-16 h-16 mx-auto mb-4" />
                    <h3 className="text-xl font-bold">Ready for Battle!</h3>
                    <p className="text-gray-300">
                      {gameState.isBossFloor 
                        ? "A powerful boss awaits you!" 
                        : "A challenger approaches!"}
                    </p>
                  </div>
                  <Button onClick={startBattle} className="text-lg px-8 py-6">
                    <Play className="mr-2 h-5 w-5" /> Start Battle
                  </Button>
                </div>
              )}

              {gameState.gameStatus === "battle" && gameState.currentEnemy && (
                <div className="space-y-6">
                  <div className="flex justify-between items-center">
                    <div className="text-center">
                      <div className="bg-gray-200 border-2 border-dashed rounded-xl w-16 h-16 mx-auto mb-2" />
                      <h3 className="font-bold">You</h3>
                      <div className="w-32 bg-gray-700 rounded-full h-2.5 mx-auto mt-2">
                        <div 
                          className="bg-green-500 h-2.5 rounded-full" 
                          style={{ width: `${(gameState.playerHealth / 1000) * 100}%` }}
                        ></div>
                      </div>
                      <p className="text-sm mt-1">{gameState.playerHealth}/1000</p>
                    </div>
                    
                    <div className="text-3xl font-bold">VS</div>
                    
                    <div className="text-center">
                      <div className="bg-gray-200 border-2 border-dashed rounded-xl w-16 h-16 mx-auto mb-2" />
                      <h3 className="font-bold">{gameState.currentEnemy.name}</h3>
                      <div className="w-32 bg-gray-700 rounded-full h-2.5 mx-auto mt-2">
                        <div 
                          className="bg-red-500 h-2.5 rounded-full" 
                          style={{ width: `${(gameState.enemyHealth / gameState.currentEnemy.health) * 100}%` }}
                        ></div>
                      </div>
                      <p className="text-sm mt-1">{gameState.enemyHealth}/{gameState.currentEnemy.health}</p>
                    </div>
                  </div>
                  
                  <div>
                    <h4 className="font-bold mb-2">Your Deck</h4>
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                      {gameState.playerDeck.map((card, index) => (
                        <Card 
                          key={`${card.id}-${index}`} 
                          className={`${getCardColor(card.rarity)} border-2 cursor-pointer hover:opacity-90 transition-opacity`}
                          onClick={() => useCard(card)}
                        >
                          <CardContent className="p-3">
                            <div className="flex justify-between items-start">
                              <div>
                                <h5 className="font-bold text-sm">{card.name}</h5>
                                <p className="text-xs">Cost: {card.cost}</p>
                              </div>
                              <span className="text-xs bg-black/20 px-1 rounded">
                                {card.type.charAt(0).toUpperCase()}
                              </span>
                            </div>
                            <div className="flex justify-between mt-2 text-xs">
                              <span>D: {card.damage}</span>
                              <span>H: {card.health}</span>
                            </div>
                          </CardContent>
                        </Card>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              {gameState.gameStatus === "victory" && (
                <div className="text-center py-8">
                  <div className="text-5xl mb-4">🎉</div>
                  <h3 className="text-2xl font-bold text-green-400 mb-2">Victory!</h3>
                  <p className="mb-6">
                    You defeated {gameState.currentEnemy?.name}!
                  </p>
                  <div className="mb-6">
                    <h4 className="font-bold mb-2">Cards Collected:</h4>
                    <div className="flex justify-center gap-2">
                      {gameState.currentEnemy?.cards.map((card, index) => (
                        <Card 
                          key={`${card.id}-reward-${index}`} 
                          className={`${getCardColor(card.rarity)} border-2 w-24`}
                        >
                          <CardContent className="p-2 text-center">
                            <div className="text-xs font-bold truncate">{card.name}</div>
                            <div className="text-xs mt-1">{card.rarity}</div>
                          </CardContent>
                        </Card>
                      ))}
                    </div>
                  </div>
                  <Button onClick={collectCards} className="px-8 py-3">
                    Collect Cards <ArrowRight className="ml-2 h-4 w-4" />
                  </Button>
                </div>
              )}

              {gameState.gameStatus === "defeat" && (
                <div className="text-center py-8">
                  <div className="text-5xl mb-4">💀</div>
                  <h3 className="text-2xl font-bold text-red-400 mb-2">Defeat!</h3>
                  <p className="mb-6">
                    You were defeated by {gameState.currentEnemy?.name}!
                  </p>
                  <Button onClick={resetGame} className="px-8 py-3">
                    Try Again
                  </Button>
                </div>
              )}
            </CardContent>
          </Card>

          {/* Battle Log */}
          <Card className="bg-blue-800/50 border-blue-700 lg:col-span-3">
            <CardHeader>
              <CardTitle className="flex items-center">
                <Heart className="mr-2" /> Battle Log
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="h-40 overflow-y-auto bg-black/20 rounded-lg p-3">
                {gameState.battleLog.map((log, index) => (
                  <div key={index} className="py-1 border-b border-gray-700 last:border-0">
                    {log}
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </div>

        <footer className="text-center py-6 text-gray-400 text-sm">
          <p>Clash Tower Climb - A Clash Royale-inspired tower climbing game</p>
          <p className="mt-1">Climb floors, collect cards, and defeat bosses every 5 floors!</p>
        </footer>
      </div>
    </div>
  );
}
